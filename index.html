<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Jmusic</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{background:#0b0f1a;color:white;font-family:system-ui;padding:20px}
select,button,input[type=range]{
  width:100%;padding:12px;margin:6px 0;
  border-radius:10px;border:none;
  background:#8b5cf6;color:white;font-weight:700
}
button.off{background:#444}
audio{width:100%;margin-top:12px}
#list button{background:#1a1f3a}
label{font-size:14px;color:#ccc}
</style>
</head>

<body>
<h2>üéµ Jmusic</h2>

<select id="playlistSelect"></select>

<button id="shuffleBtn" class="off">Shuffle: OFF</button>
<button id="loopBtn" class="off">Loop: OFF</button>
<button onclick="prev()">‚èÆ Prev</button>
<button onclick="next()">‚è≠ Next</button>

<label>üîä Volume</label>
<input id="volume" type="range" min="0" max="1" step="0.01">

<div id="list">Loading‚Ä¶</div>

<audio id="player" controls></audio>

<script>
window.addEventListener("DOMContentLoaded", () => {

const USER = "jbrimz088";
const REPO = "Jmusic";
const ROOT = "playlists";

const playlistSelect = document.getElementById("playlistSelect");
const list = document.getElementById("list");
const player = document.getElementById("player");
const shuffleBtn = document.getElementById("shuffleBtn");
const loopBtn = document.getElementById("loopBtn");
const volume = document.getElementById("volume");

let songs = [];
let order = [];
let index = 0;
let shuffle = false;
let loopOne = false;

const API = p => `https://api.github.com/repos/${USER}/${REPO}/contents/${p}`;

/* üîä Volume (FIXED) */
const savedVol = localStorage.getItem("jmusic.volume");
volume.value = savedVol !== null ? savedVol : "1";
player.volume = parseFloat(volume.value);

volume.addEventListener("input", ()=>{
  const v = parseFloat(volume.value);
  player.volume = v;
  localStorage.setItem("jmusic.volume", v);
});

/* Load playlists */
fetch(API(ROOT))
  .then(r => r.json())
  .then(folders => {
    playlistSelect.innerHTML = "";
    folders.filter(f => f.type === "dir").forEach(f => {
      const o = document.createElement("option");
      o.value = f.name;
      o.textContent = f.name;
      playlistSelect.appendChild(o);
    });
    if (playlistSelect.options.length) loadPlaylist(playlistSelect.value);
    else list.textContent = "No playlists found";
  });

playlistSelect.onchange = () => loadPlaylist(playlistSelect.value);

/* Load songs */
function loadPlaylist(name){
  fetch(API(`${ROOT}/${name}`))
    .then(r => r.json())
    .then(files => {
      songs = files.filter(f => f.name.toLowerCase().endsWith(".mp3"));
      order = songs.map((_,i)=>i);
      index = 0;
      render();
      play();
    });
}

/* Render list */
function render(){
  list.innerHTML="";
  order.forEach((i,pos)=>{
    const b=document.createElement("button");
    b.textContent = songs[i].name;
    b.onclick=()=>{ index=pos; play(); };
    list.appendChild(b);
  });
}

/* Player */
function play(){
  if(!order.length) return;
  player.src = songs[order[index]].download_url;
  player.play().catch(()=>{});
}

window.next = ()=>{
  if(!order.length) return;
  index = (index+1)%order.length;
  play();
}

window.prev = ()=>{
  if(!order.length) return;
  index = (index-1+order.length)%order.length;
  play();
}

/* Shuffle (keeps current song) */
shuffleBtn.onclick = ()=>{
  shuffle = !shuffle;
  shuffleBtn.textContent = `Shuffle: ${shuffle?"ON":"OFF"}`;
  shuffleBtn.classList.toggle("off",!shuffle);

  const current = order[index];
  const rest = order.filter(i=>i!==current);

  if(shuffle){
    for(let i=rest.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [rest[i],rest[j]]=[rest[j],rest[i]];
    }
  }

  order = [current, ...rest];
  index = 0;
  render();
};

/* Loop */
loopBtn.onclick = ()=>{
  loopOne = !loopOne;
  loopBtn.textContent = `Loop: ${loopOne?"ON":"OFF"}`;
  loopBtn.classList.toggle("off",!loopOne);
};

player.addEventListener("ended", ()=>{
  if(loopOne) play();
  else next();
});

});
</script>
</body>
</html>
