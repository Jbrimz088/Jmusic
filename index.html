<script>
const USER = "jbrimz088";
const REPO = "Jmusic";
const ROOT = "playlist"; // matches your repo

let songs = [];
let order = [];
let index = 0;
let shuffle = false;
let loopOne = false;

const list = document.getElementById("list");
const player = document.getElementById("player");
const shuffleBtn = document.getElementById("shuffleBtn");
const loopBtn = document.getElementById("loopBtn");
const playlistSelect = document.getElementById("playlistSelect");

const API = path =>
  `https://api.github.com/repos/${USER}/${REPO}/contents/${path}`;

/* LOAD PLAYLIST FOLDERS */
fetch(API(ROOT))
  .then(r=>r.json())
  .then(folders=>{
    folders.filter(f=>f.type==="dir").forEach(f=>{
      const o=document.createElement("option");
      o.value=f.name;
      o.textContent=f.name;
      playlistSelect.appendChild(o);
    });
    loadPlaylist(playlistSelect.value);
  });

playlistSelect.onchange = ()=> loadPlaylist(playlistSelect.value);

/* LOAD SONGS */
function loadPlaylist(name){
  fetch(API(`${ROOT}/${name}`))
    .then(r=>r.json())
    .then(files=>{
      songs = files.filter(f=>f.name.toLowerCase().endsWith(".mp3"));
      order = songs.map((_,i)=>i); // default order
      index = 0;
      render();
      playCurrent();
    });
}

/* RENDER LIST */
function render(){
  list.innerHTML="";
  order.forEach((songIndex,pos)=>{
    const b=document.createElement("button");
    b.textContent=songs[songIndex].name;
    b.onclick=()=>{ index=pos; playCurrent(); };
    list.appendChild(b);
  });
}

/* PLAY */
function playCurrent(){
  const song = songs[order[index]];
  if(!song) return;
  player.src = song.download_url;
  player.play();
}

/* NEXT / PREV */
function next(){
  index = (index+1) % order.length;
  playCurrent();
}
function prev(){
  index = (index-1+order.length) % order.length;
  playCurrent();
}

/* SHUFFLE (NON-DESTRUCTIVE) */
shuffleBtn.onclick = ()=>{
  shuffle = !shuffle;
  shuffleBtn.textContent = `Shuffle: ${shuffle?"ON":"OFF"}`;
  shuffleBtn.classList.toggle("off",!shuffle);

  const currentSong = order[index];

  if(shuffle){
    order = shuffleArray(order);
  }else{
    order = songs.map((_,i)=>i);
  }

  index = order.indexOf(currentSong);
  render();
};

/* LOOP ONE */
loopBtn.onclick = ()=>{
  loopOne=!loopOne;
  loopBtn.textContent=`Loop: ${loopOne?"ON":"OFF"}`;
  loopBtn.classList.toggle("off",!loopOne);
};

/* AUTO NEXT */
player.addEventListener("ended",()=>{
  if(loopOne) playCurrent();
  else next();
});

/* UTIL */
function shuffleArray(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
</script>
